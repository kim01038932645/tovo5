<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SRT Dì¡° ì¶œì„ë¶€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .calendar-cell { min-height: 80px; transition: all 0.2s; border-radius: 12px; border: 1px solid #f3f4f6; cursor: pointer; position: relative; }
        .calendar-cell:active { transform: scale(0.95); background-color: #f9fafb; }
        .today-highlight { border: 2px solid #3b82f6 !important; background-color: #eff6ff !important; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        html, body { overscroll-behavior-y: contain; height: 100%; overflow-x: hidden; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

<div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-lg flex flex-col relative">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-5 sticky top-0 z-50 shadow-md">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-2">
                <h1 class="text-xl font-bold">ğŸƒâ€â™‚ï¸ SRT Dì¡° ì¶œì„ë¶€</h1>
                <div id="topStatus" class="status-dot bg-gray-400 border border-white"></div>
            </div>
            <div id="personal-summary" class="text-[11px] font-bold bg-blue-700 px-3 py-1 rounded-full hidden">
                ì´ë²ˆ ë‹¬: <span id="my-month-dist">0.0</span>km / <span id="my-month-attend">0</span>íšŒ
            </div>
        </div>
        <select id="userSelect" class="w-full bg-blue-700 text-white text-sm rounded-xl p-3 outline-none border-none font-bold">
            <option value="">ë³¸ì¸ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”</option>
        </select>
    </header>

    <main class="flex-grow p-4 space-y-6 overflow-y-auto pb-24">
        <div class="flex justify-between items-center bg-gray-100 p-3 rounded-2xl">
            <button onclick="window.changeMonth(-1)" class="p-2 text-blue-600 font-black text-xl active:opacity-50">â—€</button>
            <span id="displayMonth" class="text-lg font-black text-blue-900 tracking-tight">ë¡œë“œ ì¤‘...</span>
            <button onclick="window.changeMonth(1)" class="p-2 text-blue-600 font-black text-xl active:opacity-50">â–¶</button>
        </div>

        <div class="space-y-4">
            <div class="grid grid-cols-7 text-center text-[10px] font-black text-gray-400 uppercase tracking-tighter">
                <div class="text-red-500">Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div class="text-blue-600">Sat</div>
            </div>
            <div id="calendar-days" class="grid grid-cols-7 gap-2"></div>
        </div>

        <div class="pt-6 border-t border-gray-100 space-y-8">
            <div>
                <h2 class="text-lg font-black text-blue-900 mb-4 flex items-center gap-2">ğŸ”¥ ê±°ë¦¬ TOP 5</h2>
                <div id="ranking-distance" class="space-y-2"></div>
            </div>
            <div>
                <h2 class="text-lg font-black text-green-700 mb-4 flex items-center gap-2">âœ… ì¶œì„ TOP 5</h2>
                <div id="ranking-attendance" class="space-y-2"></div>
            </div>
        </div>
    </main>

    <!-- Error Overlay (config missing) -->
    <div id="error-overlay" class="hidden fixed inset-0 bg-white/95 backdrop-blur-md z-[200] flex flex-col items-center justify-center p-8 text-center">
        <div class="text-5xl mb-4">ğŸ“¡</div>
        <h2 class="text-xl font-bold text-gray-800 mb-2">ì„œë²„ ì„¤ì • ëŒ€ê¸° ì¤‘</h2>
        <p class="text-sm text-gray-500 mb-6">Canvas ì‹œìŠ¤í…œì—ì„œ Firebase ì„¤ì •ê°’ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì‹œê±°ë‚˜ ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
        <button onclick="location.reload()" class="px-6 py-3 bg-blue-600 text-white rounded-full font-bold shadow-lg active:scale-95 transition-all">í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <!-- Entry Form -->
    <div id="entry-form" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[100]">
        <div class="bg-white rounded-[32px] p-8 w-full max-w-xs shadow-2xl">
            <h3 id="form-date-title" class="text-xl font-black mb-6 text-center text-gray-800">ê¸°ë¡ ì…ë ¥</h3>
            <div id="attendance-box" class="mb-6 hidden">
                <label class="flex items-center justify-between bg-blue-50 p-4 rounded-2xl cursor-pointer">
                    <span class="font-bold text-blue-900 text-sm">ê³µì‹ ëª¨ì„ ì¶œì„</span>
                    <input type="checkbox" id="attend-check" class="w-6 h-6 accent-blue-600">
                </label>
            </div>
            <div class="mb-8 text-center">
                <label class="block text-xs font-bold text-gray-400 mb-2">ëŸ¬ë‹ ê±°ë¦¬ (km)</label>
                <input type="number" id="distance-input" step="0.1" inputmode="decimal" placeholder="0.0" 
                       class="w-full text-5xl font-black text-center text-blue-600 border-b-4 border-gray-100 focus:border-blue-500 py-2 outline-none bg-transparent">
            </div>
            <div class="flex gap-3">
                <button onclick="window.closeForm()" class="flex-1 py-4 bg-gray-100 text-gray-500 rounded-2xl font-bold">ì·¨ì†Œ</button>
                <button id="saveBtn" onclick="window.saveRecord()" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-black shadow-lg">ì €ì¥</button>
            </div>
        </div>
    </div>

    <footer class="p-4 bg-gray-50 text-[10px] text-gray-400 text-center border-t border-gray-100">
        SRT D-Team Attendance System<br>
        <span id="dbStatus" class="font-bold text-blue-400">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</span>
    </footer>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- State & Variables ---
    const members = ["ê°•ë™í˜„", "ê°•ë™í›ˆ", "ì†¡ì±„í•œ", "ê¹€ë¯¸í™”", "ê¹€ì¬ì‚°", "ê¹€ì°¬ì„", "ê¹€í•œë‚˜", "ë¥˜ì§€ì°¬", "ë°•ì„±í™˜", "ë°•ì¢…ë´‰", "ì†Œë³‘ë“", "ì„œì •í™”", "ì‹ ì˜ì„­", "ì•ˆì§€í›ˆ", "ì˜¤í•œì²œ", "ì´ìŠ¹ì¤€", "ì´ìš©êµ¬", "ì •ë•ìˆ˜", "ì£¼íš¨ì„", "ì„œì¸ìˆ˜", "ë°•ì°½ì„ ", "ê¹€ë³‘ì‹"].sort();
    let currentViewDate = new Date(); currentViewDate.setDate(1);
    let allRecords = [];
    let currentUser = null;
    let activeDate = "";
    let db = null;
    let auth = null;
    
    // UI References
    const statusText = document.getElementById('dbStatus');
    const statusDot = document.getElementById('topStatus');
    const userSelect = document.getElementById('userSelect');
    const errorOverlay = document.getElementById('error-overlay');

    // Setup User List
    members.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m; opt.textContent = m;
        userSelect.appendChild(opt);
    });
    if (localStorage.getItem('srt_user_name')) userSelect.value = localStorage.getItem('srt_user_name');

    // --- Firebase Initialization Flow ---
    async function startApp() {
        // 1. Wait for Firebase Config (Increased robustness)
        let config = null;
        statusText.textContent = "ì„¤ì •ê°’ ì£¼ì… ëŒ€ê¸° ì¤‘...";

        // ìµœëŒ€ 10ì´ˆê¹Œì§€ í´ë§ (í™˜ê²½ì— ë”°ë¼ ëŠ¦ê²Œ ì£¼ì…ë  ìˆ˜ ìˆìŒ)
        for (let i = 0; i < 100; i++) {
            if (typeof window.__firebase_config !== 'undefined' && window.__firebase_config) {
                try {
                    config = JSON.parse(window.__firebase_config);
                    break;
                } catch (e) {
                    console.error("JSON Parse Error on Config", e);
                }
            }
            await new Promise(r => setTimeout(r, 100));
        }

        if (!config) {
            statusText.textContent = "ì—°ê²° ì˜¤ë¥˜: ì„œë²„ ì„¤ì •ê°’ì´ ì—†ìŠµë‹ˆë‹¤.";
            statusDot.className = "status-dot bg-red-500 border border-white";
            errorOverlay.classList.remove('hidden');
            return;
        }

        // 2. Initialize Firebase
        try {
            const app = initializeApp(config);
            auth = getAuth(app);
            db = getFirestore(app);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'srt-d-team-v1';

            // 3. Strict Authentication First
            statusText.textContent = "ìµëª… ì¸ì¦ ì‹œë„ ì¤‘...";
            
            // Re-usable auth logic with retry
            const login = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) {
                    console.error("Auth attempt failed", e);
                    setTimeout(login, 2000); // ì‹¤íŒ¨ ì‹œ 2ì´ˆ í›„ ì¬ì‹œë„
                }
            };
            
            await login();

            // 4. On Auth State Changed -> Start Sync
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    statusDot.className = "status-dot bg-green-500 border border-white";
                    statusText.textContent = "ì˜¨ë¼ì¸: ì„œë²„ ì—°ê²°ë¨";
                    errorOverlay.classList.add('hidden');
                    initRealtimeSync(appId);
                } else {
                    statusDot.className = "status-dot bg-yellow-500 border border-white";
                    statusText.textContent = "ì¸ì¦ ëŒ€ê¸° ì¤‘...";
                }
            });

        } catch (e) {
            statusText.textContent = "ì´ˆê¸°í™” ì˜¤ë¥˜: " + e.message;
            statusDot.className = "status-dot bg-red-500 border border-white";
        }
    }

    function initRealtimeSync(appId) {
        // ê·œì¹™ 1 ì¤€ìˆ˜: /artifacts/{appId}/public/data/records
        const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'records');
        
        onSnapshot(colRef, (snapshot) => {
            allRecords = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            renderAll();
        }, (err) => {
            statusText.textContent = "ë°ì´í„° ë™ê¸°í™” ì‹¤íŒ¨: " + err.code;
            console.error("Firestore Snapshot Error", err);
        });
    }

    // --- UI Logic ---
    function renderAll() {
        renderCalendar();
        renderRanking();
        updateSummary();
    }

    function renderCalendar() {
        const y = currentViewDate.getFullYear();
        const m = currentViewDate.getMonth();
        document.getElementById('displayMonth').textContent = `${y}ë…„ ${m + 1}ì›”`;
        
        const firstDay = new Date(y, m, 1).getDay();
        const lastDate = new Date(y, m + 1, 0).getDate();
        const container = document.getElementById('calendar-days');
        container.innerHTML = "";

        for (let i = 0; i < firstDay; i++) container.appendChild(document.createElement('div'));

        const myName = userSelect.value;
        const prefix = `${y}-${String(m+1).padStart(2,'0')}`;

        for (let d = 1; d <= lastDate; d++) {
            const dateStr = `${prefix}-${String(d).padStart(2,'0')}`;
            const dateObj = new Date(y, m, d);
            const isToday = new Date().toDateString() === dateObj.toDateString();
            const isSpecial = dateObj.getDay() === 3 || dateObj.getDay() === 0;

            const cell = document.createElement('div');
            cell.className = `calendar-cell p-2 flex flex-col justify-between ${isSpecial ? 'bg-orange-50/50' : 'bg-white'} ${isToday ? 'today-highlight' : ''}`;
            cell.onclick = () => window.openForm(dateStr, isSpecial);

            const dNum = document.createElement('span');
            dNum.className = `text-[10px] font-bold ${dateObj.getDay() === 0 ? 'text-red-500' : dateObj.getDay() === 6 ? 'text-blue-500' : 'text-gray-400'}`;
            dNum.textContent = d;

            const content = document.createElement('div');
            content.className = "flex flex-col items-center gap-0.5 mb-1";
            
            const dayData = allRecords.filter(r => r.date === dateStr);
            if (myName) {
                const my = dayData.find(r => r.name === myName);
                if (my?.attended) content.innerHTML += `<div class="text-[14px]">âœ…</div>`;
                if (my?.distance > 0) content.innerHTML += `<div class="text-[9px] font-black text-blue-700 bg-blue-100 px-1 rounded-sm">${my.distance}k</div>`;
            } else {
                const totalD = dayData.reduce((s, r) => s + (Number(r.distance) || 0), 0);
                if (totalD > 0) content.innerHTML += `<div class="text-[8px] font-bold text-blue-500">Î£${totalD.toFixed(1)}</div>`;
            }

            cell.append(dNum, content);
            container.appendChild(cell);
        }
    }

    function renderRanking() {
        const prefix = `${currentViewDate.getFullYear()}-${String(currentViewDate.getMonth() + 1).padStart(2, '0')}`;
        const stats = {};
        members.forEach(m => stats[m] = { d: 0, a: 0 });
        
        allRecords.forEach(r => {
            if (r.date.startsWith(prefix) && stats[r.name]) {
                stats[r.name].d += (Number(r.distance) || 0);
                if (r.attended) stats[r.name].a += 1;
            }
        });

        const dRank = Object.entries(stats).sort((a,b) => b[1].d - a[1].d).filter(x => x[1].d > 0).slice(0, 5);
        const aRank = Object.entries(stats).sort((a,b) => b[1].a - a[1].a).filter(x => x[1].a > 0).slice(0, 5);

        const dCont = document.getElementById('ranking-distance');
        dCont.innerHTML = dRank.length ? "" : "<p class='text-center text-gray-300 text-[10px] py-4'>ê¸°ë¡ ì—†ìŒ</p>";
        dRank.forEach(([n, v], i) => dCont.innerHTML += rankItem(i, n, v.d.toFixed(1)+'km', 'blue'));

        const aCont = document.getElementById('ranking-attendance');
        aCont.innerHTML = aRank.length ? "" : "<p class='text-center text-gray-300 text-[10px] py-4'>ê¸°ë¡ ì—†ìŒ</p>";
        aRank.forEach(([n, v], i) => aCont.innerHTML += rankItem(i, n, v.a+'íšŒ', 'green'));
    }

    function rankItem(i, n, v, c) {
        const isFirst = i === 0;
        const bg = c === 'blue' ? (isFirst?'bg-blue-600 text-white shadow-blue-200':'bg-white border-blue-50') : (isFirst?'bg-green-600 text-white shadow-green-200':'bg-white border-green-50');
        return `<div class="flex items-center p-3 rounded-2xl border ${bg} mb-1 shadow-sm transition-all">
            <span class="w-6 font-black text-[10px] opacity-70">${i+1}</span>
            <span class="flex-grow font-bold text-xs">${n}</span>
            <span class="font-black text-xs">${v}</span>
        </div>`;
    }

    function updateSummary() {
        const name = userSelect.value;
        const box = document.getElementById('personal-summary');
        if (!name) { box.classList.add('hidden'); return; }
        const prefix = `${currentViewDate.getFullYear()}-${String(currentViewDate.getMonth() + 1).padStart(2, '0')}`;
        const my = allRecords.filter(r => r.name === name && r.date.startsWith(prefix));
        document.getElementById('my-month-dist').textContent = my.reduce((s, r) => s + (Number(r.distance) || 0), 0).toFixed(1);
        document.getElementById('my-month-attend').textContent = my.filter(r => r.attended).length;
        box.classList.remove('hidden');
    }

    // --- Global Actions ---
    window.changeMonth = (dir) => {
        currentViewDate.setMonth(currentViewDate.getMonth() + dir);
        renderAll();
    };

    window.openForm = (date, special) => {
        if (!userSelect.value) { alert("ìƒë‹¨ì—ì„œ ì´ë¦„ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
        activeDate = date;
        const [, m, d] = date.split('-');
        document.getElementById('form-date-title').textContent = `${parseInt(m)}ì›” ${parseInt(d)}ì¼ ê¸°ë¡`;
        document.getElementById('attendance-box').classList.toggle('hidden', !special);
        const rec = allRecords.find(r => r.date === date && r.name === userSelect.value);
        document.getElementById('attend-check').checked = rec?.attended || false;
        document.getElementById('distance-input').value = rec?.distance || "";
        document.getElementById('entry-form').classList.remove('hidden');
    };

    window.closeForm = () => document.getElementById('entry-form').classList.add('hidden');

    window.saveRecord = async () => {
        if (!currentUser || !db) { alert("ì„œë²„ì™€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return; }
        const name = userSelect.value;
        const dist = parseFloat(document.getElementById('distance-input').value) || 0;
        const attended = document.getElementById('attend-check').checked;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'srt-d-team-v1';
        
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'records', `${name}_${activeDate}`);
        const btn = document.getElementById('saveBtn');
        btn.disabled = true; btn.textContent = "ì €ì¥ ì¤‘...";

        try {
            if (dist === 0 && !attended) await deleteDoc(docRef);
            else await setDoc(docRef, { name, date: activeDate, distance: dist, attended, ts: Date.now() });
            window.closeForm();
        } catch (e) {
            alert("ì €ì¥ ì˜¤ë¥˜: " + e.code);
        } finally {
            btn.disabled = false; btn.textContent = "ì €ì¥";
        }
    };

    userSelect.onchange = () => {
        localStorage.setItem('srt_user_name', userSelect.value);
        renderAll();
    };

    // --- Execution ---
    startApp();
    renderAll();
</script>

</body>
</html>
