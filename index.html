<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SRT Dì¡° ì¶œì„ë¶€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .calendar-cell { min-height: 70px; transition: background-color 0.2s; position: relative; }
        .calendar-cell:active { background-color: #f3f4f6; }
        .today-highlight { border: 2px solid #3b82f6 !important; background-color: #eff6ff !important; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        /* Prevent bounce on mobile */
        html, body { overscroll-behavior-y: contain; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

<div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-lg flex flex-col">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 sticky top-0 z-50 shadow-md">
        <div class="flex justify-between items-start mb-3">
            <div>
                <div class="flex items-center gap-2">
                    <h1 class="text-xl font-bold text-white">ğŸƒâ€â™‚ï¸ SRT Dì¡° ì¶œì„ë¶€</h1>
                    <div id="statusIndicator" class="w-2.5 h-2.5 rounded-full bg-gray-400 border border-white"></div>
                </div>
                <div id="personal-summary" class="text-[11px] mt-1 font-medium opacity-90 hidden">
                    <span class="bg-blue-700 px-2 py-0.5 rounded-full mr-1">ì´ë²ˆ ë‹¬: <span id="my-month-dist">0.0</span>km</span>
                    <span class="bg-blue-700 px-2 py-0.5 rounded-full">ì¶œì„: <span id="my-month-attend">0</span>íšŒ</span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <select id="userSelect" class="bg-blue-700 text-white text-sm rounded-lg p-2.5 outline-none border-none flex-grow appearance-none cursor-pointer">
                <option value="">ë³¸ì¸ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”</option>
            </select>
        </div>
    </header>

    <main class="flex-grow p-4 space-y-6 overflow-y-auto pb-24">
        <div id="monthNav" class="flex justify-between items-center bg-blue-50 p-2 rounded-xl">
            <button onclick="changeMonth(-1)" class="p-2 text-blue-600 font-black text-xl active:scale-95 transition-transform">â—€</button>
            <span id="displayMonth" class="text-lg font-black text-blue-900">2026ë…„ 1ì›”</span>
            <button onclick="changeMonth(1)" class="p-2 text-blue-600 font-black text-xl active:scale-95 transition-transform">â–¶</button>
        </div>

        <!-- Calendar Section -->
        <div id="section-calendar" class="space-y-4">
            <div class="grid grid-cols-7 text-center text-xs font-bold text-gray-400 mb-2">
                <div class="text-red-500 font-bold uppercase">Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div class="text-blue-600 font-bold uppercase">Sat</div>
            </div>
            <div id="calendar-days" class="grid grid-cols-7 gap-1.5"></div>
        </div>

        <!-- Ranking Section -->
        <div id="section-rankings" class="pt-6 border-t-2 border-dashed border-gray-100 space-y-8">
            <div>
                <h2 class="text-lg font-black text-blue-900 mb-4 flex items-center gap-2">ğŸ”¥ ëˆ„ì  ê±°ë¦¬ TOP 5</h2>
                <div id="ranking-distance" class="space-y-2"></div>
            </div>
            <div>
                <h2 class="text-lg font-black text-green-700 mb-4 flex items-center gap-2">âœ… ê³µì‹ ì¶œì„ TOP 5</h2>
                <div id="ranking-attendance" class="space-y-2"></div>
            </div>
        </div>

        <!-- Form Modal -->
        <div id="entry-form" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[100]">
            <div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl transform transition-all">
                <h3 id="form-date-title" class="text-xl font-black mb-6 text-center text-gray-800">ë‚ ì§œ ê¸°ë¡</h3>
                <div id="attendance-box" class="mb-5 hidden">
                    <label class="flex items-center justify-between bg-blue-50 p-4 rounded-2xl cursor-pointer border-2 border-transparent hover:border-blue-200 transition-all">
                        <span class="font-bold text-blue-900 text-sm">ê³µì‹ ëª¨ì„ ì¶œì„</span>
                        <input type="checkbox" id="attend-check" class="w-6 h-6 rounded-full accent-blue-600">
                    </label>
                </div>
                <div class="mb-8 text-center">
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">ëŸ¬ë‹ ê±°ë¦¬ (km)</label>
                    <input type="number" id="distance-input" step="0.1" inputmode="decimal" placeholder="0.0" 
                           class="w-full text-4xl font-black text-center text-blue-600 border-b-4 border-gray-100 focus:border-blue-500 py-2 outline-none bg-transparent">
                </div>
                <div class="flex gap-3">
                    <button onclick="closeForm()" class="flex-1 py-4 bg-gray-100 text-gray-500 rounded-2xl font-bold active:bg-gray-200 transition-colors">ì·¨ì†Œ</button>
                    <button id="saveBtn" onclick="saveRecord()" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-black shadow-lg active:scale-95 transition-transform">ì €ì¥</button>
                </div>
            </div>
        </div>
    </main>

    <footer class="p-6 bg-gray-50 text-[10px] text-gray-400 text-center border-t">
        SRT D-Team Performance Tracker<br>
        <span id="dbStatus">ì—°ê²° í™•ì¸ ì¤‘...</span>
    </footer>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, onSnapshot, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // GitHub ì—…ë¡œë“œ ì‹œì—ë„ ì•ˆì „í•˜ë„ë¡ í™˜ê²½ ë³€ìˆ˜ í•¸ë“¤ë§ ê°•í™”
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
        apiKey: "AIza...", // ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš© ì§ì ‘ ì…ë ¥ ì‹œ ì—¬ê¸°ì—
        authDomain: "toeic-vaca-5.firebaseapp.com",
        projectId: "toeic-vaca-5",
        storageBucket: "toeic-vaca-5.firebasestorage.app",
        messagingSenderId: "73640394276",
        appId: "1:73640394276:web:6bec2125251952017862b1"
    };

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'srt-d-team-prod';
    const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const members = ["ê°•ë™í˜„", "ê°•ë™í›ˆ", "ì†¡ì±„í•œ", "ê¹€ë¯¸í™”", "ê¹€ì¬ì‚°", "ê¹€ì°¬ì„", "ê¹€í•œë‚˜", "ë¥˜ì§€ì°¬", "ë°•ì„±í™˜", "ë°•ì¢…ë´‰", "ì†Œë³‘ë“", "ì„œì •í™”", "ì‹ ì˜ì„­", "ì•ˆì§€í›ˆ", "ì˜¤í•œì²œ", "ì´ìŠ¹ì¤€", "ì´ìš©êµ¬", "ì •ë•ìˆ˜", "ì£¼íš¨ì„", "ì„œì¸ìˆ˜", "ë°•ì°½ì„ ", "ê¹€ë³‘ì‹"].sort();
    
    const today = new Date();
    let currentViewDate = new Date(today.getFullYear(), today.getMonth(), 1);
    let allRecords = [];

    // ì¸ì¦ í•¨ìˆ˜ (GitHub Pages ë“± ì™¸ë¶€ í˜¸ìŠ¤íŒ… ì‹œì—ë„ ëŒ€ì‘)
    const initAuth = async () => {
        try {
            if (initialToken) {
                await signInWithCustomToken(auth, initialToken);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Auth Failure:", error);
            document.getElementById('dbStatus').textContent = "ì¸ì¦ ì‹¤íŒ¨ (ìµëª… ë¡œê·¸ì¸ì„ í™œì„±í™”í•˜ì„¸ìš”)";
        }
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('dbStatus').textContent = "ì—°ê²° ì™„ë£Œ";
            document.getElementById('statusIndicator').className = "w-2.5 h-2.5 rounded-full bg-green-500 border border-white";
            startSync();
        }
    });

    function startSync() {
        const q = collection(db, 'artifacts', appId, 'public', 'data', 'records');
        onSnapshot(q, (snapshot) => {
            allRecords = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            updateUI();
        }, (err) => {
            console.error("Firestore Error:", err);
            document.getElementById('dbStatus').textContent = "ë°ì´í„° ì—°ë™ ê¶Œí•œ ì—†ìŒ";
        });
    }

    function updateUI() {
        renderCalendar();
        renderRanking();
        updatePersonalSummary();
    }

    const userSelect = document.getElementById('userSelect');
    members.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name;
        userSelect.appendChild(opt);
    });

    window.changeMonth = (dir) => {
        currentViewDate.setMonth(currentViewDate.getMonth() + dir);
        updateUI();
    };

    function renderCalendar() {
        const year = currentViewDate.getFullYear();
        const month = currentViewDate.getMonth();
        document.getElementById('displayMonth').textContent = `${year}ë…„ ${month + 1}ì›”`;
        
        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        const container = document.getElementById('calendar-days');
        container.innerHTML = "";

        for (let i = 0; i < firstDay; i++) {
            const empty = document.createElement('div');
            container.appendChild(empty);
        }

        const userName = userSelect.value;
        const monthPrefix = `${year}-${String(month+1).padStart(2,'0')}`;
        const monthRecords = allRecords.filter(r => r.date.startsWith(monthPrefix));

        for (let d = 1; d <= lastDate; d++) {
            const dateStr = `${monthPrefix}-${String(d).padStart(2,'0')}`;
            const dateObj = new Date(year, month, d);
            const isWedSun = dateObj.getDay() === 3 || dateObj.getDay() === 0;
            const isToday = (year === today.getFullYear() && month === today.getMonth() && d === today.getDate());
            
            const cell = document.createElement('div');
            cell.className = `calendar-cell border rounded-xl p-1 text-center flex flex-col justify-between cursor-pointer active:scale-95 transition-all ${isWedSun ? 'bg-orange-50 border-orange-100' : 'bg-white border-gray-100'} ${isToday ? 'today-highlight shadow-inner' : ''}`;
            cell.onclick = () => openForm(dateStr, isWedSun);

            const dayNum = document.createElement('span');
            dayNum.className = `text-[10px] font-black ${dateObj.getDay() === 0 ? 'text-red-500' : dateObj.getDay() === 6 ? 'text-blue-600' : 'text-gray-400'}`;
            dayNum.textContent = d;

            const content = document.createElement('div');
            content.className = "flex flex-col items-center gap-0.5 mb-1";
            
            const dateData = monthRecords.filter(r => r.date === dateStr);
            if (userName) {
                const myRec = dateData.find(r => r.name === userName);
                if (myRec) {
                    if (myRec.attended) content.innerHTML += `<div class="text-[12px] animate-bounce">âœ…</div>`;
                    if (myRec.distance > 0) content.innerHTML += `<div class="text-[9px] font-black text-gray-800 bg-yellow-100 px-1 rounded">${myRec.distance}k</div>`;
                }
            } else {
                const totalDist = dateData.reduce((a, b) => a + (Number(b.distance) || 0), 0);
                const totalAttend = dateData.filter(r => r.attended).length;
                if (totalDist > 0) content.innerHTML += `<div class="text-[8px] font-bold text-blue-500">Î£${totalDist.toFixed(1)}</div>`;
                if (totalAttend > 0) content.innerHTML += `<div class="text-[8px] font-bold text-green-600">ğŸ‘¤${totalAttend}</div>`;
            }

            cell.appendChild(dayNum);
            cell.appendChild(content);
            container.appendChild(cell);
        }
    }

    function renderRanking() {
        const prefix = `${currentViewDate.getFullYear()}-${String(currentViewDate.getMonth() + 1).padStart(2, '0')}`;
        const distStats = {};
        const attendStats = {};
        members.forEach(m => { distStats[m] = 0; attendStats[m] = 0; });

        allRecords.forEach(r => {
            if (r.date.startsWith(prefix)) {
                distStats[r.name] += (Number(r.distance) || 0);
                if (r.attended) attendStats[r.name] += 1;
            }
        });

        const sortedDist = Object.entries(distStats).sort((a, b) => b[1] - a[1]).filter(x => x[1] > 0).slice(0, 5);
        const distContainer = document.getElementById('ranking-distance');
        distContainer.innerHTML = sortedDist.length === 0 ? `<div class="text-xs text-gray-300 italic text-center p-4">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>` : "";
        sortedDist.forEach(([name, val], i) => distContainer.appendChild(createRankItem(i, name, val.toFixed(1) + ' km', 'blue')));

        const sortedAttend = Object.entries(attendStats).sort((a, b) => b[1] - a[1]).filter(x => x[1] > 0).slice(0, 5);
        const attendContainer = document.getElementById('ranking-attendance');
        attendContainer.innerHTML = sortedAttend.length === 0 ? `<div class="text-xs text-gray-300 italic text-center p-4">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>` : "";
        sortedAttend.forEach(([name, val], i) => attendContainer.appendChild(createRankItem(i, name, val + ' íšŒ', 'green')));
    }

    function createRankItem(i, name, valueText, color) {
        const item = document.createElement('div');
        const colorClass = color === 'blue' ? 'from-blue-500 to-blue-600' : 'from-green-500 to-green-600';
        const rankBg = i === 0 ? `bg-gradient-to-r ${colorClass} text-white shadow-lg` : 'bg-white text-gray-700 border border-gray-100';
        item.className = `flex items-center p-3.5 rounded-2xl ${rankBg} transition-transform hover:scale-[1.02]`;
        item.innerHTML = `<span class="w-8 font-black text-sm">${i+1}</span><span class="flex-grow font-bold text-sm">${name}</span><span class="font-black text-sm text-right">${valueText}</span>`;
        return item;
    }

    function updatePersonalSummary() {
        const userName = userSelect.value;
        if (!userName) { document.getElementById('personal-summary').classList.add('hidden'); return; }
        const prefix = `${currentViewDate.getFullYear()}-${String(currentViewDate.getMonth() + 1).padStart(2, '0')}`;
        const myMonthRecords = allRecords.filter(r => r.name === userName && r.date.startsWith(prefix));
        document.getElementById('my-month-dist').textContent = myMonthRecords.reduce((acc, cur) => acc + (Number(cur.distance) || 0), 0).toFixed(1);
        document.getElementById('my-month-attend').textContent = myMonthRecords.filter(r => r.attended).length;
        document.getElementById('personal-summary').classList.remove('hidden');
    }

    let selectedDate = "";
    window.openForm = (date, isSpecial) => {
        if (!userSelect.value) {
            alert("ì´ë¦„ì„ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.");
            userSelect.focus();
            return;
        }
        selectedDate = date;
        const [y, m, d] = date.split('-');
        document.getElementById('form-date-title').textContent = `${parseInt(m)}ì›” ${parseInt(d)}ì¼ ê¸°ë¡`;
        document.getElementById('attendance-box').classList.toggle('hidden', !isSpecial);
        const rec = allRecords.find(r => r.date === date && r.name === userSelect.value);
        document.getElementById('attend-check').checked = rec?.attended || false;
        document.getElementById('distance-input').value = rec?.distance || "";
        document.getElementById('entry-form').classList.remove('hidden');
    };

    window.closeForm = () => document.getElementById('entry-form').classList.add('hidden');

    window.saveRecord = async () => {
        if (!auth.currentUser) return alert("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¤‘ì…ë‹ˆë‹¤.");
        
        const name = userSelect.value;
        const dist = parseFloat(document.getElementById('distance-input').value) || 0;
        const attended = document.getElementById('attend-check').checked;
        const docId = `${name}_${selectedDate}`;
        const ref = doc(db, 'artifacts', appId, 'public', 'data', 'records', docId);

        try {
            if (dist === 0 && !attended) {
                await deleteDoc(ref);
            } else {
                await setDoc(ref, { 
                    name, 
                    date: selectedDate, 
                    distance: dist, 
                    attended, 
                    updatedAt: Date.now() 
                });
            }
            closeForm();
        } catch (e) {
            console.error("Save Error:", e);
            alert("ì €ì¥ ì‹¤íŒ¨! ë³¸ì¸ì˜ ë°ì´í„°ë§Œ ìˆ˜ì • ê°€ëŠ¥í•œì§€ ë˜ëŠ” Firebase ê·œì¹™ì„ í™•ì¸í•´ ë³´ì„¸ìš”.");
        }
    };

    userSelect.onchange = () => updateUI();
    initAuth();
</script>

</body>
</html>
